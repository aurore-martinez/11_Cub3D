V = false

ifeq ($(V),true)
	ECHO =
else
	ECHO = @
endif

# Nom du programme
NAME = cub3D

# Compilation
CC = cc
CFLAGS = -Wall -Wextra -Werror -g3 #-fsanitize=address
OS = $(shell uname | tr '[:upper:]' '[:lower:]')

MAKE = make -sC
MKDIR = mkdir -p
RM = rm -rf

# Lib perso
LIB_DIR = lib
LIB = $(LIB_DIR)/lib.a
LINKER = $(LIB)

# Info syst√®me
$(info üñ•Ô∏è OS d√©tect√© : $(OS))

# MiniLibX - Platform-dependent compilation
MLX_BASE ?= minilibx
ifeq ($(OS),linux)
	MLX_DIR         := $(MLX_BASE)/minilibx-linux
	MLX             := $(MLX_DIR)/libmlx.a
	INCLUDES_FLAG   += -I$(MLX_DIR)
	LINKER          += -L$(MLX_DIR) -lmlx -lm -lz -lXext -lX11
else
	# macOS ‚Äî d√©tection du support Metal (FR/EN) + pr√©sence du dossier Metal
	METAL_SUPPORTED := $(shell system_profiler SPDisplaysDataType 2>/dev/null | grep -Eiq 'Metal.*(Pris en charge|Supported)' && echo yes || echo no)
	HAS_METAL_DIR   := $(shell test -d $(MLX_BASE)/minilibx_macos_metal && echo yes)

ifneq ($(and $(METAL_SUPPORTED),$(HAS_METAL_DIR)),)
	# ‚Üí Metal OK
	MLX_DIR         := $(MLX_BASE)/minilibx_macos_metal
	MLX             := $(MLX_DIR)/libmlx.a
	INCLUDES_FLAG   += -I$(MLX_DIR)
	LINKER          += -L$(MLX_DIR) -lmlx -framework Metal -framework MetalKit -framework AppKit
else
	# ‚Üí fallback OpenGL
	MLX_DIR         := $(MLX_BASE)/minilibx_macos_opengl
	MLX             := $(MLX_DIR)/libmlx.a
	INCLUDES_FLAG   += -I$(MLX_DIR)
	LINKER          += -L$(MLX_DIR) -lmlx -framework OpenGL -framework AppKit
endif
endif

# Includes
INCLUDE_DIR = include
LIB_SUBDIR = $(wildcard $(LIB_DIR)/*)

INCLUDE_FLAG = -I$(INCLUDE_DIR) \
			   $(foreach dir, $(LIB_SUBDIR), -I$(dir))

INCLUDE = $(wildcard $(INCLUDE_DIR)/*.h) \
		  $(foreach dir, $(LIB_SUBDIR), $(wildcard $(dir)/*.h))

# Dossiers sources
SRC_DIR = src/

# Fichiers sources (relatifs √† SRC_DIR)


SRC_FILES = main.c



# Chemins complets des sources et objets
SRCS = $(addprefix $(SRC_DIR), $(SRC_FILES))
OBJS_DIR = objs/
OBJS = $(addprefix $(OBJS_DIR), $(SRC_FILES:.c=.o))

# Couleurs ANSI
GREEN = \033[32m
RED = \033[31m
RESET = \033[0m
YELLOW = \033[33m
CLEAR_LINE = \033[2K\r
PINK  = \033[95m
WHITE = \033[97m

# Logo cool
logo ?= false   # false => affiche le logo, true => masque

PRINT_LOGO = \
	if [ "$(logo)" = "true" ]; then \
	echo ""; \
	printf "$(PINK)"; \
	printf "                                                                                         \n"; \
	printf "_|        _|                                                        _|_|_|    _|_|_|    \n"; \
	printf "_|              _|_|_|    _|_|    _|  _|_|  _|_|_|      _|_|              _|  _|    _|  \n"; \
	printf "_|        _|  _|        _|    _|  _|_|      _|    _|  _|_|_|_|        _|_|    _|    _|  \n"; \
	printf "_|        _|  _|        _|    _|  _|        _|    _|  _|                  _|  _|    _|  \n"; \
	printf "_|_|_|_|  _|    _|_|_|    _|_|    _|        _|    _|    _|_|_|      _|_|_|    _|_|_|    \n"; \
	printf "$(RESET)"; \
	printf "$(WHITE)"; \
	printf "                                   L I C O R N E   3 D                                     \n"; \
	printf "$(RESET)\n"; \
	echo "  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"; \
	echo "  ‚îÇ                             ‚îÇ"; \
	echo "  ‚îÇ  FPS = Frames Per Segfault  ‚îÇ"; \
	echo "  ‚îÇ                             ‚îÇ"; \
	echo "  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"; \
	echo "                                           "; \
	echo "     lea ü§ù aumartin"; \
	fi


# Compilation principale
all: $(LIB) $(MLX) $(NAME)
	@$(PRINT_LOGO)


# Compilation lib
$(LIB):
	@echo "$(YELLOW)üì¶ Compilation de la lib...$(RESET)\r"
	@$(MAKE) $(LIB_DIR) > /dev/null 2>&1 \
	&& echo -e "$(CLEAR_LINE)‚úÖ Compilation lib r√©ussie (‚úî)" \
	|| { echo -e "$(CLEAR_LINE)‚ùå Erreur : Compilation de la lib √©chou√©e (‚úò)"; exit 1; }

$(MLX):
	@echo "$(YELLOW)üì¶ Compilation de MiniLibX...$(RESET)\r"
	@$(MAKE) $(MLX_DIR) > /dev/null 2>&1 \
	&& echo -e "$(CLEAR_LINE)‚úÖ Compilation mlx r√©ussie (‚úî)" \
	|| { echo -e "$(CLEAR_LINE)‚ùå Erreur : Compilation de MiniLibX √©chou√©e (‚úò)"; exit 1; }

# R√®gle pour objets
$(OBJS_DIR):
	@$(MKDIR) $(OBJS_DIR)

$(OBJS_DIR)%.o: $(SRC_DIR)%.c $(INCLUDE)
	@mkdir -p $(dir $@)
	@$(CC) $(CFLAGS) $(INCLUDE_FLAG) -c $< -o $@

$(OBJS_DIR)main.o: main.c $(INCLUDE) | $(OBJS_DIR)
	@$(CC) $(CFLAGS) $(INCLUDE_FLAG) -c $< -o $(OBJS_DIR)main.o

# Compilation du binaire
$(NAME): $(OBJS) $(LIB) $(MLX)
	@echo "üöÄ Compilation de $(NAME)..."
	@$(CC) $(CFLAGS) $(OBJS) $(LINKER) -o $(NAME) && echo "‚úÖ $(NAME) a √©t√© cr√©√© avec succ√®s (‚úî)" \

# Nettoyage
clean:
	@echo "$(YELLOW)üßπ Nettoyage clean en cours...$(RESET)\r"
	@$(RM) $(OBJS_DIR)
	@echo -e "$(CLEAR_LINE)‚úÖ Nettoyage clean r√©ussi (‚úî)"

fclean: clean
	@echo "$(YELLOW)üßº Nettoyage complet fclean en cours...$(RESET)\r"
	@$(RM) $(NAME)
	@$(MAKE) $(LIB_DIR) fclean
	@$(MAKE) $(MLX_DIR) clean
	@echo -e "$(CLEAR_LINE)‚úÖ Nettoyage complet fclean r√©ussi (‚úî)"

re: fclean all

.PHONY: all clean fclean re
